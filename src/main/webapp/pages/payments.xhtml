<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui" xmlns:b="http://bootsfaces.net/ui"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:shiro="http://shiro.apache.org/tags">
	
	<b:panel ajax="false">
	
	
			<b:modal id="pleaseWaitModal" 
			            title="Loading"
			            backdrop="false"
			            styleClass="pleaseWaitModalClass" >
			    
						    <h1><img src="javax.faces.resource/images/waitcursor.gif.jsf?ln=bsf" /></h1>
			</b:modal>	
	
			<b:modal
			            title="Broker transaction logs" 
			            styleClass="responsiveModalPseudoClass" 
			            widgetVar="tableWidgetVar" 
			            size="modal-lg">
			    
						    <p>
						    	<b:dataTable 
						    	scroll-x="false" page-length="10" fixedHeader="true" responsive="true" ajax="true" style="display nowrap" style-class="display nowrap"
					class="paymentNotificationLogTable" id="paymentNotificationLogTable" value="#{paymentProcessAuditBean.paymentNotificationRawLog}" var="rawLog">
								
								<b:dataTableColumn value="#{rawLog.timeStamp}" label="Trx Date" >
								</b:dataTableColumn>
								<b:dataTableColumn value="#{rawLog.systemID}" label="Source System" />
								<b:dataTableColumn value="#{rawLog.sourcehost}" label="Source Host"/>
								<b:dataTableColumn value="#{rawLog.systemMsg}" label="Narrative"/>
								
								</b:dataTable>
								
						    </p>
						    <f:facet name="footer">
						        <b:button value="Close" dismiss="modal" />
						    </f:facet>
			</b:modal>	
	
		</b:panel>
		<b:panel class="content" id="formdd" style="margin: auto; width: 100%; border: 0px solid green; padding: 5px;">
			<h1>Broker Payments</h1>
			<h:form id="searchForm">
				<b:row>
					<b:column span="7" style-class="message">
						<b:message id="messagex" for="searchbtn"
							line-break-tag="&lt;p&gt;&lt;hr /&gt;&lt;/p&gt;" />
					</b:column>
				</b:row>
				<b:row>
					<b:column></b:column>
				</b:row>
				<b:row>
					<b:column span="2">
						<h:outputText value="Invoice #/Trx. Ref:" for="query" />
					</b:column>
					<b:column span="5">
						<b:inputText placeholder="Invoice #/Trx. Ref:" id="query"
							value="#{paymentNotificationBean.queryDTO.query}" ajax="true"
							autocomplete="false" update="@(.messagex)">
							<f:facet name="prepend">
								<b:icon name="iphone" />
							</f:facet>
						</b:inputText>
					</b:column>
				</b:row>

				<b:row>
					<b:column span="2">
						<h:outputText value="Date from" for="dateFrom" />
					</b:column>
					<b:column span="5">
						<b:datepicker placeholder="Date From" mode="icon-popup"
							value="#{paymentNotificationBean.queryDTO.dateFrom}" />
					</b:column>
				</b:row>
				<b:row>
					<b:column></b:column>
				</b:row>
				<b:row>
					<b:column span="2">
						<h:outputText value="Date to" for="dateTo" />
					</b:column>
					<b:column span="5">
						<b:datepicker placeholder="Date To" mode="icon-popup"
							value="#{paymentNotificationBean.queryDTO.dateTo}" />
					</b:column>
				</b:row>
				<b:row>
					<b:column></b:column>
				</b:row>
				<b:row>
					<b:column></b:column>
				</b:row>
				<b:row>
					<b:column span="3" offset="2">
						<b:commandButton id="searchbtn" value="search" ajax="true"
							update="@this, @form,:traxTable" onclick="ajax:paymentNotificationBean.query()"
							look="primary" style="width:100%" />
					</b:column>
					<b:column span="2" >
						<ui:remove>
							<b:commandButton value="Download PDF" action="#{paymentNotificationBean.downloadReport()}"  ajax="false" style="width:100%" ></b:commandButton>
						</ui:remove>
					</b:column>
				</b:row>

			</h:form>
			
			
		</b:panel>

		<b:panel>
			
			<b:dataTable  paginated="true"
			responsive="true" scroll-horizontally="true" widgetVar="tableWidgetVar" striped="false"
				id="traxTable" value="#{paymentNotificationBean.payments}" var="payment"   
				row-style-class="#{payment.status =='SUCCESS' ? 'okCls' : (payment.status =='FAILED_PERMANENTLY'  ? 'dangerCls' : 'warningCls') } ">
				<b:dataTableColumn data-type='date' value="" label="Trx Date" >
					<h:outputText value="#{payment.transactionDate}">
						<f:convertDateTime type="date" pattern="dd-MMM-yy hh:mm" />
					</h:outputText>
				</b:dataTableColumn>
				<b:dataTableColumn value="#{payment.invoiceNo}" label="Inv. #" />
				<b:dataTableColumn value="#{payment.currencyCode}" label="Currency"/>
				<b:dataTableColumn  label="Amount." contentStyle="align: right;" >
					<h:outputText value="#{payment.amount}" >
						<f:convertNumber pattern="#,##0.00;(#,##0.00)"  />
					</h:outputText>
				</b:dataTableColumn>
				<b:dataTableColumn value="#{payment.paymentMode}" label="Pmt Mode"/>
				<b:dataTableColumn value="#{payment.transactionRef}" label="Trx. Ref"/>
				<b:dataTableColumn value="#{payment.status}" label="Status">
					<b:button value="More..." 
					 	size="xs" look="link" icon="glyphicon glyphicon-question-sign" 
					 	onclick="showModal(); setInvoiceNo( '#{payment.invoiceNo}' )" ></b:button>
					<b:remoteCommand  
						actionListener="#{paymentProcessAuditBean.getMoreInfo}"
						name="setInvoiceNo" parameters="invoiceNo"
		              	onsuccess="hideModal(); $('.responsiveModalPseudoClass').modal(); tableWidgetVar.DataTable().responsive.recalc();" 
		              	update="@(.paymentNotificationLogTable)" >
		             </b:remoteCommand>
					
		      </b:dataTableColumn>	
				
				<b:dataTableColumn value="" label="Action" >
					
					<b:button id="rbtn2_#{payment.id}" rendered="#{payment.status == 'FAILED_PERMANENTLY'}"  value="Re-try"  size="xs"  look="warning" icon="glyphicon glyphicon-repeat" update="@form,:traxTable"
			                onclick="reTryInvoiceProcessing( '#{payment.invoiceNo}' )" >
			        </b:button>
			        
			        <b:remoteCommand  id="rbtn3_#{payment.id}"
						actionListener="#{paymentNotificationRetryBean.reTryInvoiceProcessing}"
						name="reTryInvoiceProcessing" parameters="invoiceNoToRetry"
		              	onsuccess="tableWidgetVar.DataTable().responsive.recalc();" 
		              	update="@(.traxTable)" >
		             </b:remoteCommand>
		           
				</b:dataTableColumn>
			</b:dataTable>
		</b:panel>
		
		<script type="text/javascript">
			function showModal(){
				//var pleaseWaitModal = $('#pleaseWaitModal');
				//console.log(pleaseWaitModal);
				//pleaseWaitModal.modal();
			}

			function hideModal(){
				//var pleaseWaitModal = $('#pleaseWaitModal');
				//console.log(pleaseWaitModal);
				//pleaseWaitModal.hide(); 
				//pleaseWaitModal.removeClass("modal fade in"); 
			}
			
		</script>
		

	</ui:composition>
	
	
